---
title: "Antares new features v8.6.0"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Antares_new_features_v860}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(antaresEditObject)
```

This thumbnail will present the new features in line with **Antares v8.6.0** (the link is [here](https://antares-simulator.readthedocs.io/en/latest/reference-guide/13-file-format/#v860))

There are 3 new features :  

>  - Add new storage type "short-term storage".  

>  - Update parameters of thermal clusters with "pollutant emission factors"  

>  - "Hydro Pmin" : new file "mingen.txt"

## Create new study

```{r init}
dir_path <- tempdir()
createStudy(path = dir_path, 
            study_name = "test860", 
            antares_version = "8.6.0")
```

## Create area 

```{r areas}
createArea(name = "fr")
createArea(name = "it")
```

## Create "st-storage"

We can create new st-storage cluster with new function `createClusterST()`. You can see function documentation with `?createClusterST`.  

By default you can call function only with two parameters (`area`, `cluster_name`). 

```{r st-storage}
inflows_data <- matrix(3, 8760)
ratio_values <- matrix(0.7, 8760)

createClusterST(area = "fr", 
                cluster_name = "test_storage", 
                storage_parameters = storage_values_default(), 
                PMAX_injection = ratio_values, 
                PMAX_withdrawal = ratio_values, 
                inflows = inflows_data, 
                lower_rule_curve = ratio_values, 
                upper_rule_curve = ratio_values, 
                overwrite = TRUE)

createClusterST(area = "it", 
                cluster_name = "test_storage", 
                storage_parameters = storage_values_default(), 
                PMAX_injection = ratio_values, 
                PMAX_withdrawal = ratio_values, 
                inflows = inflows_data, 
                lower_rule_curve = ratio_values, 
                upper_rule_curve = ratio_values, 
                overwrite = TRUE)
```


Now you can see informations in simulation options. 

```{r study options}
opts <- simOptions()
opts$areasWithSTClusters

```

## Read st-storages parameters
After creating "st-storage" clusters, you can read all informations with specific function `readClusterSTDesc()`.

```{r read st-storage param}
tab <- readClusterSTDesc()
rmarkdown::paged_table(tab)
```

## Read st-storages data

St-storages data are time series you can read for all areas or a specific area. 5 files contening one time series are generated (one per each function parameter):  

 - PMAX-injection.txt  
 - PMAX-withdrawal.txt  
 - inflows.txt  
 - lower-rule-curve.txt  
 - upper-rule-curve.txt  

```{r read st-storage data}
data_st_storage <- readInputTS(st_storage = "all")
rmarkdown::paged_table(head(data_st_storage))
```

As you can see, the last two columns (`st-storage`,  `name_file`) give you value for each name file.  
**FI** : As default, reading option for hourly timestep is `r opts$timeIdMax` (see `opts$timeIdMax`).

## Edit st-storage

It is possible to edit parameters values et data values like you want.   

```{r edit st-storage}
# edit parameters values 
list_params_st <- storage_values_default()
list_params_st$efficiency <- 0.5
list_params_st$reservoircapacity <- 50

# edit data values
inflows_data <- matrix(4, 8760)

editClusterST(area = "fr", 
              cluster_name = "test_storage", 
              storage_parameters = list_params_st,
              inflows = inflows_data,
              add_prefix = TRUE)

# read parameters
tab <- readClusterSTDesc()
rmarkdown::paged_table(tab)

# read data
data_st_storage <- readInputTS(st_storage = "all")
rmarkdown::paged_table(head(data_st_storage))
```

## Remove st-storage

Creating or editing st-storage are done, you can also remove clusters from study.   

```{r remove st-storage opts}
# remove cluster
removeClusterST(area = "fr", 
                cluster_name = "test_storage", 
                add_prefix = TRUE)

# delete control 
opts <- simOptions()
opts$areasWithSTClusters
```

The area `fr` is deleted cause we created only one cluster `test_storage`.  

```{r remove st-storage}
# control removed parameters
tab <- readClusterSTDesc()
rmarkdown::paged_table(head(tab))

# control removed data
data_st_storage <- readInputTS(st_storage = "all")
rmarkdown::paged_table(head(data_st_storage))

unique(data_st_storage$area)
```

Parameters and data concerning this cluster in this area are removed.

## Thermal polluants parameters

Antares version 8.6.0 now provide polluants parameters for thermal clusters. you can view the documentation on thermal clusters [here](https://rte-antares-rpackage.github.io/antaresEditObject/articles/antaresEditObject.html#create-a-new-cluster).  

You have global `list` of pulluants given by function `list_polluants_values()`. By default, parameters are NULL, you can initialise all parameters with value or customise parameters.

```{r}
# create cluster with polluants

# polluants
all_param_polluants <- list_polluants_values(multi_values = 0.25)

createCluster(area = "fr", 
              cluster_name = "test_polluant", 
              unitcount = 1L, 
              marginal_cost = 50,
              list_polluants = all_param_polluants, 
              time_series = matrix(rep(c(0, 8000), each = 24*364), ncol = 2),
              prepro_modulation = matrix(rep(c(1, 1, 1, 0), each = 24*365), ncol = 4) 
              )
```

```{r polluants param}
# read parameters
param_th_cluster <- readClusterDesc()
rmarkdown::paged_table(param_th_cluster)
```

See how edit list of polluants parameters. Let's see how edit 3 parameters **`r names(list_polluants_values())[1:3]`**.  

```{r edit polluants}
# editing
edit_param_polluants <- list_polluants_values(multi_values = 0.3)[1:3]

editCluster(area = "fr", 
            cluster_name = "test_polluant",
            unitcount = 2L, 
            list_polluants = edit_param_polluants)

# read parameters
param_th_cluster <- readClusterDesc()
rmarkdown::paged_table(param_th_cluster)
```

## Hydro - MINGEN file

Antares version 8.6.0 provide new file `mingen.txt`, this file is directly checked with file `mod.txt`.   
You have 2 different type of check, dimension and values.  
  
Full documentation is available with function `writeInputTS()`. We will see further informations for values checks.   

**Values checks : **  

Checks depends of values of parameters in `hydro.ini` file.

```{r schema, echo=FALSE, fig.cap="", out.width = '65%', fig.align='center'}
path_image <- sourcedir860 <- system.file("doc/schemas", package = "antaresEditObject")
knitr::include_graphics(file.path(path_image,"mingen.png"))
```

A start, just after creation study, `.txt` files containing time series are empty. We will see steps to write `mingen.txt`.

```{r write mingen}
# Initialize mingen data (time series)
mingen_data = matrix(0.06,8760,5)

# 1 - edit mod file (time series)
mod_data = matrix(6,365,5)
writeInputTS(area = "fr", type = "hydroSTOR", 
             data = mod_data, 
             overwrite = TRUE)

# 2 - edit maxpower (have to be > value mingen)
maxpower_data <- matrix(6,365,4)
writeHydroValues(area = "fr", 
                 type = "maxpower", 
                 data = maxpower_data)

  # 4- edit mingen
writeInputTS(area = "fr", type = "mingen", 
             data = mingen_data, 
             overwrite = TRUE)
```

Now we can read time series. 

```{r read mingen}
# read input time series
read_ts_file <- readInputTS(mingen = "all")
rmarkdown::paged_table(head(read_ts_file))
```


```{r delete study, include=FALSE}
#Delete study
    unlink(opts$studyPath, 
           recursive = TRUE)
# clean global options
options(antares = NULL)
```



